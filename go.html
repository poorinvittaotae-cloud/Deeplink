<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="robots" content="noindex,nofollow">
<title>Open in ReadAWrite</title>
<style>
  :root{color-scheme:light dark}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:16px;line-height:1.5}
  .card{max-width:780px;margin:0 auto;padding:16px;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  a.btn,button.btn{display:inline-block;text-decoration:none;border:0;border-radius:999px;padding:12px 16px;font-weight:700;cursor:pointer}
  .primary{background:#111827;color:#fff}
  .ghost{background:#f3f4f6;color:#111827}
  .hint{font-size:14px;opacity:.88;margin-top:8px}
  .ok{color:#059669}
  .hide{display:none}
</style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 6px">เปิดด้วยแอป ReadAWrite</h2>
    <div id="why" class="hint">ถ้าเปิดจาก Facebook/LINE แล้วไม่เด้ง ให้ใช้ปุ่มด้านล่าง</div>

    <div class="row">
      <!-- ปุ่มหลักเป็น <a> จริง เพื่อให้ FB/LINE อนุญาตการนำทาง -->
      <a id="openAppLink" class="btn primary" rel="noopener noreferrer">เปิดในแอป</a>
      <button id="openWeb" class="btn ghost" type="button">เปิดด้วยเบราว์เซอร์หลัก</button>
      <button id="copy" class="btn ghost" type="button">คัดลอกลิงก์</button>
    </div>

    <div id="tips" class="hint"></div>
    <div id="copied" class="hint ok hide">คัดลอกลิงก์แล้ว — วางใน Chrome/Safari เพื่อเปิด</div>
    <p class="hint" id="longHint"></p>
  </div>

<script>
/* ===== CONFIG (แก้ได้ตามต้องการ) ===== */
const SCHEME = "readawrite";
const ANDROID_PKG = "com.readawrite";
const IOS_STORE = "https://apps.apple.com/th/app/readawrite/id1033832353";
const PLAY_STORE = "https://play.google.com/store/apps/details?id=" + ANDROID_PKG;

/* รับปลายทาง:
   1) ?path=a/<articleId>  (แนะนำ)
   2) ?url=https://www.readawrite.com/a/<id>  (สำรอง) */
const qs = new URLSearchParams(location.search);
let PATH = (qs.get("path") || "").replace(/^\/+/, "");
const RAW_URL = qs.get("url");
const DEFAULT_PATH = "a/512604c87af04b0b7d3d02f31a2289be"; // เปลี่ยนได้
if (!PATH && RAW_URL) {
  try { PATH = new URL(RAW_URL).pathname.replace(/^\/+/, ""); } catch {}
}
if (!PATH) PATH = DEFAULT_PATH;
const WEB_URL = "https://www.readawrite.com/" + PATH;

/* ===== ตรวจสภาพแวดล้อม ===== */
const UA = navigator.userAgent || "";
const isAndroid = /Android/i.test(UA);
const isIOS     = /iPhone|iPad|iPod/i.test(UA);
const isFB      = /\bFBAN|FBAV\b/i.test(UA);
const isLINE    = /Line/i.test(UA);
const isIG      = /Instagram/i.test(UA);
const isInApp   = isFB || isLINE || isIG;

/* ===== helper ===== */
const $ = id => document.getElementById(id);
function info(m){ $("tips").textContent = m||""; }
function showCopied(){ const el=$("copied"); el.classList.remove("hide"); setTimeout(()=>el.classList.add("hide"), 2000); }

/* ถ้าเปิดแอปจริง หน้า web จะ visibility=hidden → ยกเลิก fallback */
function guardVisibility(onTimeout, ms){
  let done=false;
  const tid=setTimeout(()=>{ if(!done){ done=true; cleanup(); onTimeout(); } }, ms);
  const onVis=()=>{ if(document.visibilityState==="hidden" && !done){ done=true; cleanup(); } };
  function cleanup(){ clearTimeout(tid); document.removeEventListener("visibilitychange", onVis); }
  document.addEventListener("visibilitychange", onVis);
}

/* ===== ตั้งค่า <a> เปิดแอป ให้ “คลิกครั้งเดียวพาออกได้จริง” ===== */
(function configureOpenAppLink(){
  const link = $("openAppLink");
  if (isAndroid) {
    // intent:// + fallback ไป WEB_URL (ถ้าไม่มีแอป)
    link.href = `intent://${PATH}`+
                `#Intent;scheme=${SCHEME};package=${ANDROID_PKG};`+
                `S.browser_fallback_url=${encodeURIComponent(WEB_URL)};end`;
  } else if (isIOS) {
    // iOS ใช้สคีมโดยตรง + เฝ้า visibility เพื่อ fallback ไป App Store
    link.href = `${SCHEME}://${PATH}`;
    link.addEventListener("click", ()=> {
      guardVisibility(()=>{ location.href = IOS_STORE; }, 1000);
    });
  } else {
    link.href = WEB_URL; // desktop
  }
})();

/* ===== กรณีอยู่ใน FB/LINE/IG บน Android → เปลี่ยน flow เพื่อเลี่ยงการบล็อก ===== */
(function swapPrimaryButtonIfBlocked(){
  if (isAndroid && isInApp) {
    const openAppLink = $("openAppLink");
    openAppLink.textContent = "เปิดด้วยเบราว์เซอร์หลัก";
    openAppLink.classList.remove("primary");
    openAppLink.classList.add("ghost");
    openAppLink.removeAttribute("href");
    openAppLink.addEventListener("click", ()=>{
      try { window.open(WEB_URL, "_blank", "noopener"); } catch(e){}
      setTimeout(()=>{ location.href = WEB_URL; }, 120);
      alert("ถ้าเว็บยังเปิดในแอป Facebook/LINE ให้แตะ ⋯ หรือ แชร์ แล้วเลือก 'เปิดในเบราว์เซอร์ภายนอก'");
    });

    $("why").textContent = "Facebook/LINE บล็อกการเปิดแอปโดยตรง ให้กด 'เปิดด้วยเบราว์เซอร์หลัก' ก่อน";
    $("longHint").textContent = "ทริก: แตะค้างที่ปุ่มแล้วเลือก 'เปิดลิงก์ภายนอก' จะออกไป Chrome ได้เร็ว";
  }
})();

/* ===== ปุ่ม 'เปิดด้วยเบราว์เซอร์หลัก' (ใช้งานได้ทุกที่) ===== */
$("openWeb").addEventListener("click", ()=>{
  try { window.open(WEB_URL, "_blank", "noopener"); } catch(e){}
  setTimeout(()=>{ location.href = WEB_URL; }, 120);
  if (isIOS && isInApp) {
    info("บน iPhone: แตะ ⋯ หรือ แชร์ แล้วเลือก 'เปิดใน Safari' แล้วค่อยกด 'เปิดในแอป'");
    alert("บน iPhone ให้แตะ ⋯ หรือ แชร์ แล้วเลือก 'Open in Safari'");
  }
});

/* ===== คัดลอกลิงก์ lander (เผื่อแชร์ต่อ/วางใน Chrome/Safari) ===== */
$("copy").addEventListener("click", async ()=>{
  try { await navigator.clipboard.writeText(location.href); showCopied(); }
  catch { alert("คัดลอกไม่สำเร็จ: แตะค้างที่แถบที่อยู่แล้วเลือกคัดลอก"); }
});

/* ===== Auto‑launch (เฉพาะนอก in‑app) เพื่อความลื่น ===== */
(function autoLaunchWhenSafe(){
  if (isInApp) {
    // In‑app: ให้ผู้ใช้กดเองตาม flow ที่ไม่ถูกบล็อก
    if (isIOS) info("บน iPhone ให้แตะ ⋯ หรือ แชร์ → 'เปิดใน Safari' แล้วกด 'เปิดในแอป'");
    else info("ถ้าไม่เด้ง ให้กด 'เปิดด้วยเบราว์เซอร์หลัก' เพื่อออกจากแอปก่อน");
    return;
  }
  // นอก in‑app → ลอง auto
  info("กำลังพยายามเปิดในแอปอัตโนมัติ…");
  setTimeout(()=>{
    if (isAndroid) {
      // Chrome ชอบสคีมตรงมากกว่า intent ตอน auto
      guardVisibility(()=>{ location.href = PLAY_STORE; }, 1200);
      location.href = `${SCHEME}://${PATH}`;
    } else if (isIOS) {
      guardVisibility(()=>{ location.href = IOS_STORE; }, 1000);
      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = `${SCHEME}://${PATH}`;
      document.body.appendChild(iframe);
    }
  }, 350);
})();
</script>
</body>
</html>
