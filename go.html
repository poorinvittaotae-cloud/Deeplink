<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Open in ReadAWrite</title>
<style>
  :root{color-scheme:light dark}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px;line-height:1.5}
  .card{max-width:720px;margin:0 auto;padding:16px;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{border:0;border-radius:999px;padding:11px 16px;font-weight:700;cursor:pointer}
  .primary{background:#111827;color:#fff}
  .ghost{background:#f3f4f6;color:#111827}
  .hint{font-size:14px;opacity:.85;margin-top:8px}
  .ok{color:#059669}
  .hide{display:none}
</style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 6px">เปิดด้วยแอป ReadAWrite</h2>
    <div id="why" class="hint">ถ้าอยู่ใน Facebook/LINE แล้วไม่เด้ง ให้กดปุ่มด้านล่าง</div>

    <div class="row">
      <button id="openApp" class="primary">เปิดในแอป</button>
      <button id="openWeb" class="ghost">เปิดด้วยเบราว์เซอร์หลัก</button>
      <button id="copy" class="ghost">คัดลอกลิงก์</button>
    </div>

    <div id="tips" class="hint"></div>
    <div id="copied" class="hint ok hide">คัดลอกลิงก์แล้ว — วางใน Chrome/Safari เพื่อเปิด</div>
  </div>

<script>
/* ===== CONFIG ===== */
const SCHEME = "readawrite";
const ANDROID_PKG = "com.readawrite";
const IOS_STORE = "https://apps.apple.com/th/app/readawrite/id1033832353";
const PLAY_STORE = "https://play.google.com/store/apps/details?id=" + ANDROID_PKG;

// ?path=a/<id>
const qs = new URLSearchParams(location.search);
const PATH = (qs.get("path") || "a/512604c87af04b0b7d3d02f31a2289be").replace(/^\/+/, "");
const WEB_URL = "https://www.readawrite.com/" + PATH;

/* ===== UA detect ===== */
const UA = navigator.userAgent || "";
const isAndroid = /Android/i.test(UA);
const isIOS     = /iPhone|iPad|iPod/i.test(UA);
const isFB      = /\bFBAN|FBAV\b/i.test(UA);
const isLINE    = /Line/i.test(UA);
const isIG      = /Instagram/i.test(UA);
const isInApp   = isFB || isLINE || isIG;

/* ===== helpers ===== */
const schemeUrl = () => `${SCHEME}://${PATH}`;
function info(msg){ document.getElementById("tips").textContent = msg || ""; }
function showCopied(){ const el = document.getElementById("copied"); el.classList.remove("hide"); setTimeout(()=>el.classList.add("hide"),2000); }

/* เปิดแอปแบบไม่ใช้ intent:// และยกเลิก fallback หากสลับไปแอปได้จริง */
function launchByScheme() {
  let fired = false;
  const t = setTimeout(()=>{
    if (fired) return;                    // แอปเปิดสำเร็จ → ไม่ fallback
    // ไม่เด้ง → ไปสโตร์ก่อน (มีโอกาสติดตั้ง) แล้วผู้ใช้กดกลับก็ยังอยู่หน้านี้
    location.href = isIOS ? IOS_STORE : PLAY_STORE;
  }, 1200);

  const onHide = () => { fired = true; clearTimeout(t); document.removeEventListener('visibilitychange', onHide); };
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'hidden') onHide();
  });

  // iOS ใช้ iframe, Android ใช้ location.href ก็ได้ (ทั้งคู่ต้องมาจาก user-gesture)
  if (isIOS) {
    const iframe = document.createElement('iframe');
    iframe.style.display='none'; iframe.src = schemeUrl();
    document.body.appendChild(iframe);
  } else {
    // หลีกเลี่ยง intent:// เพื่อไม่ให้เปิด Chrome แล้วขึ้นหน้า "ไม่พบรายการ"
    location.href = schemeUrl();
  }
}

function openApp() {
  // ถ้าอยู่ใน in-app บางตัว block auto-redirect → แต่เมื่อกดปุ่มถือเป็น user gesture จึงอนุญาต
  launchByScheme();
}

function openWeb() {
  try { window.open(WEB_URL, "_blank", "noopener"); } catch(_) {}
  setTimeout(()=>{ location.href = WEB_URL; }, 150);
  if (isIOS && isInApp) {
    info("บน iPhone: แตะ ⋯ หรือ แชร์ แล้วเลือก 'เปิดใน Safari' แล้วค่อยกด 'เปิดในแอป'");
    alert("บน iPhone ให้แตะ ⋯ หรือ แชร์ แล้วเลือก 'Open in Safari'");
  }
}

async function copyLink(){
  try { await navigator.clipboard.writeText(location.href); showCopied(); }
  catch { alert("คัดลอกไม่สำเร็จ: แตะค้างที่แถบที่อยู่แล้วเลือกคัดลอก"); }
}

/* hints */
(function init(){
  if (isInApp && isAndroid) info("ถ้าไม่เด้ง ให้กด 'เปิดด้วยเบราว์เซอร์หลัก' เพื่อออกจาก Facebook/LINE แล้วค่อยกด 'เปิดในแอป'");
  else if (isInApp && isIOS) info("บน iPhone ให้แตะ ⋯ หรือ แชร์ แล้วเลือก 'เปิดใน Safari' จากนั้นกด 'เปิดในแอป'");
  else info("กำลังพยายามเปิดในแอปอัตโนมัติ… ถ้าไม่เด้ง ให้ใช้ปุ่มด้านบน");
  // อยู่นอก in-app → ลอง auto หลังโหลดสั้น ๆ (ไม่ใช่ intent, จึงไม่ขึ้นหน้าดาว)
  if (!isInApp && (isAndroid || isIOS)) setTimeout(launchByScheme, 400);
})();

/* bind */
document.getElementById('openApp').addEventListener('click', openApp);
document.getElementById('openWeb').addEventListener('click', openWeb);
document.getElementById('copy').addEventListener('click', copyLink);
</script>
</body>
</html>
