<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>เปิดด้วยแอป ReadAWrite</title>
<meta name="robots" content="noindex,nofollow">
<style>
  :root{color-scheme:light dark}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#fff;color:#0b1220}
  .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px}
  .card{max-width:760px;width:100%;border-radius:18px;border:1px solid #e5e7eb;padding:24px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
  .brand{font-weight:800;letter-spacing:.4px;color:#94a3b8;font-size:12px}
  h1{margin:6px 0 10px;font-size:28px;letter-spacing:.2px}
  .desc{color:#64748b;margin:0 0 14px}
  .hero{display:flex;gap:16px;align-items:center;justify-content:center;margin:10px 0 18px}
  .phone{width:200px;height:200px;flex:0 0 auto}
  .btns{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
  a.btn,button.btn{flex:1 1 220px;max-width:300px;border-radius:12px;border:2px solid #16a34a;
    padding:14px 16px;font-weight:800;text-decoration:none;text-align:center;cursor:pointer}
  .primary{background:#16a34a;color:#fff}
  .ghost{background:#fff;color:#16a34a}
  .mini{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px}
  .mini .btn{border-color:#cbd5e1;color:#475569}
  .hint{font-size:13px;color:#64748b;text-align:center;min-height:40px;margin-top:10px}
  .line{height:1px;background:#e5e7eb;margin:16px 0}
  .foot{margin-top:6px;text-align:center;font-size:12px;color:#94a3b8}
  .tips{background:#fff7ed;border:1px dashed #fdba74;color:#9a3412;border-radius:10px;padding:10px 12px;margin-top:10px;font-size:13px}
  @media (max-width:560px){ .hero{flex-direction:column} .phone{width:160px;height:160px} }
  @media (prefers-color-scheme:dark){
    body{background:#0b0b0b;color:#e5e7eb}
    .card{border-color:#1f2937;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .desc,.hint{color:#9aa4b2}
    .ghost{background:transparent}
    .line{background:#1f2937}
    .mini .btn{border-color:#334155;color:#cbd5e1}
    .tips{background:#0b1220;border-color:#334155;color:#cbd5e1}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="main">
    <div class="brand">readawrite.com</div>
    <h1 id="title">เปิดด้วยแอป ReadAWrite</h1>
    <p class="desc" id="desc">ถ้าเปิดจาก Facebook/LINE แล้วไม่เด้ง ให้กด ‘เปิดด้วยเบราว์เซอร์หลัก’ ก่อน แล้วค่อยกด ‘เปิดในแอป’</p>

    <div class="hero" aria-hidden="true">
      <svg class="phone" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="55" y="25" width="90" height="150" rx="16" stroke="#111827" stroke-width="4"/>
        <circle cx="100" cy="100" r="28" fill="#16a34a"/>
        <path d="M100 84v32M84 100h32" stroke="#fff" stroke-width="6" stroke-linecap="round"/>
      </svg>
    </div>

    <div class="btns" id="btnRow">
      <a id="openPrimary" class="btn primary" rel="noopener">เปิดในแอป</a>
      <a id="openBrowser" class="btn ghost" rel="noopener" target="_blank">เปิดด้วยเบราว์เซอร์หลัก</a>
    </div>

    <div class="mini">
      <button id="copyBtn" class="btn" type="button">คัดลอกลิงก์</button>
      <a id="getApp" class="btn" rel="noopener" target="_blank">ดาวน์โหลดแอป</a>
    </div>

    <div id="hint" class="hint"></div>
    <div id="tips" class="tips" style="display:none"></div>

    <div class="line"></div>
    <div class="foot">ระบบมี fallback อัตโนมัติ และป้องกันการค้างด้วย visibility‑guard</div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const SCHEME      = "readawrite";
const ANDROID_PKG = "com.readawrite";
const PLAY        = "https://play.google.com/store/apps/details?id="+ANDROID_PKG;
const APPSTORE    = "https://apps.apple.com/th/app/readawrite/id1033832353";
const DEFAULT_PATH= "a/512604c87af04b0b7d3d02f31a2289be"; // แก้ได้

/* ===== รับปลายทางจากพารามิเตอร์ =====
   รองรับ ?path=a/<id> หรือ ?url=https://www.readawrite.com/a/<id> */
const qs = new URLSearchParams(location.search);
let PATH = (qs.get("path")||"").replace(/^\/+/, "");
const RAW_URL = qs.get("url");
if (!PATH && RAW_URL) { try { PATH = new URL(RAW_URL).pathname.replace(/^\/+/, ""); } catch {} }
if (!PATH) PATH = DEFAULT_PATH;

const WEB  = "https://www.readawrite.com/" + PATH;

/* ===================== ENV DETECT ===================== */
const ua = navigator.userAgent || "";
const isAndroid = /Android/i.test(ua);
const isIOS     = /iPhone|iPad|iPod/i.test(ua);

// in-app browsers ที่พบบ่อย
const isFB      = /\bFBAN|FBAV\b/i.test(ua);
const isIG      = /Instagram/i.test(ua);
const isLINE    = /Line/i.test(ua);
const isTT      = /TikTok/i.test(ua);
const isX       = /Twitter|CriOS.+Twitter/i.test(ua);
const isInApp   = isFB || isIG || isLINE || isTT || isX;

// องค์ประกอบ DOM
const $ = s => document.querySelector(s);
const openPrimary = $("#openPrimary");
const openBrowser = $("#openBrowser");
const copyBtn     = $("#copyBtn");
const getApp      = $("#getApp");
const hint        = $("#hint");
const tips        = $("#tips");

/* ===================== HELPERS ===================== */
function visibilityGuard(onTimeout, ms){
  let fired=false;
  const t = setTimeout(()=>{ if(!fired){ fired=true; cleanup(); onTimeout(); } }, ms);
  const onVis = () => {
    if (document.visibilityState === "hidden" && !fired) {
      fired = true; cleanup();
    }
  };
  function cleanup(){ clearTimeout(t); document.removeEventListener("visibilitychange", onVis); }
  document.addEventListener("visibilitychange", onVis);
}

function androidIntent(){
  return `intent://${PATH}#Intent;scheme=${SCHEME};package=${ANDROID_PKG};` +
         `S.browser_fallback_url=${encodeURIComponent(WEB)};end`;
}

/* ===================== INIT LINKS ===================== */
openBrowser.href = WEB;
getApp.href      = isIOS ? APPSTORE : PLAY;

/* ===== คัดลอกลิงก์ ===== */
copyBtn.addEventListener("click", async () => {
  try{
    await navigator.clipboard.writeText(WEB);
    copyBtn.textContent="คัดลอกแล้ว ✓";
    setTimeout(()=>copyBtn.textContent="คัดลอกลิงก์",1400);
  }catch{
    alert("คัดลอกไม่สำเร็จ ให้กดค้างที่ลิงก์แล้วคัดลอกด้วยตัวเอง");
  }
});

/* ===== กลยุทธ์เปิดแอป (กันพัง) ===== */
function openAppAndroid(){
  // ใช้ top-level navigation เพื่อให้ FB/LINE แสดงป๊อปอัปยืนยัน
  visibilityGuard(()=>{ location.href = WEB; }, 1400);
  try{ location.href = `${SCHEME}://${PATH}`; }catch(_){}
  // เสริม intent อีกชั้นสำหรับรอม/เบราว์เซอร์บางรุ่น
  setTimeout(()=>{ try{ location.href = androidIntent(); }catch(_){} }, 120);
}

function openAppIOS(){
  visibilityGuard(()=>{ location.href = APPSTORE; }, 1100);
  // แรกสุดลองเปิดด้วยสคีม
  try{ location.href = `${SCHEME}://${PATH}`; }catch(_){}
  // บางเคส Safari ต้องใช้ iframe trick
  setTimeout(()=>{
    const f=document.createElement("iframe");
    f.style.display="none"; f.src=`${SCHEME}://${PATH}`;
    document.body.appendChild(f);
    setTimeout(()=>{ try{ document.body.removeChild(f); }catch(_){} }, 1600);
  }, 100);
}

/* ===== ปุ่มหลัก (สลับตำแหน่งอัตโนมัติเมื่ออยู่ใน In‑App) ===== */
function makePrimary(el){ el.classList.add("primary"); el.classList.remove("ghost"); }
function makeGhost(el){ el.classList.add("ghost"); el.classList.remove("primary"); }

if (isInApp) {
  // อยู่ในแอปโซเชียล: ทำให้ปุ่ม "เปิดด้วยเบราว์เซอร์หลัก" เป็นปุ่มหลักเพื่อให้ออกนอก WebView ก่อน
  makePrimary(openBrowser);
  makeGhost(openPrimary);
  openPrimary.textContent = "เปิดในแอป";
  hint.textContent = isIOS
    ? "บน iPhone ให้แตะ ⋯ หรือ แชร์ แล้วเลือก ‘Open in Safari’ จากนั้นกด ‘เปิดในแอป’"
    : "กำลังอยู่ใน Facebook/LINE/แอปอื่น ให้กด ‘เปิดด้วยเบราว์เซอร์หลัก’ ก่อน แล้วค่อยกด ‘เปิดในแอป’";
  tips.style.display="block";
  tips.textContent = "เหตุผล: In‑App Browser กันการเด้งไปแอปเพื่อความปลอดภัย เว็บจึงต้องพาคุณออกไปยังเบราว์เซอร์หลักก่อน";

} else {
  // อยู่นอก In‑App: ให้ “เปิดในแอป” เป็นปุ่มหลัก (เด้งได้เสถียรสุด)
  makePrimary(openPrimary);
  makeGhost(openBrowser);
  hint.textContent = "กำลังพยายามเปิดแอปอัตโนมัติ… ถ้าไม่เด้ง ให้กดปุ่มด้านบน";
  // ลอง auto-launch อย่างสุภาพ (หน่วงเล็กน้อยเพื่อหลบ gesture/back)
  setTimeout(()=>{ isAndroid ? openAppAndroid() : isIOS ? openAppIOS() : null; }, 350);
}

/* ===== คลิกปุ่ม ===== */
openPrimary.addEventListener("click",(e)=>{
  e.preventDefault();
  if (isAndroid) openAppAndroid();
  else if (isIOS) openAppIOS();
  else location.href = WEB; // เดสก์ท็อป
});

/* ===== เพิ่มความชัดเจนของหัวเรื่อง เมื่ออยู่ใน In‑App ===== */
if (isInApp) {
  $("#title").textContent = "ออกจากแอปนี้ก่อน แล้วค่อยเปิดด้วย ReadAWrite";
  $("#desc").textContent  = "กด ‘เปิดด้วยเบราว์เซอร์หลัก’ ก่อนเพื่อออกจาก Facebook/LINE จากนั้นกด ‘เปิดในแอป’";
}
</script>
</body>
</html>
