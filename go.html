<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>เปิดด้วยแอป ReadAWrite</title>
<meta name="format-detection" content="telephone=no" />
<meta name="referrer" content="no-referrer" />
<style>
  :root{--bg:#fff;--fg:#0b1220;--muted:#6b7280;--pri:#0ea5e9;--pri-fg:#fff;--bd:#e5e7eb;}
  @media (prefers-color-scheme: dark){
    :root{--bg:#0b1220;--fg:#f3f4f6;--muted:#9ca3af;--pri:#38bdf8;--pri-fg:#0b1220;--bd:#1f2937;}
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif}
  .wrap{max-width:720px;margin:0 auto;padding:24px}
  .card{background:rgba(255,255,255,0.6);backdrop-filter:saturate(1.2) blur(6px);border:1px solid var(--bd);border-radius:18px;padding:20px}
  @media (prefers-color-scheme: dark){.card{background:rgba(17,24,39,0.6)}}
  h1{margin:4px 0 12px;font-size:24px}
  p{margin:0 0 16px;color:var(--muted)}
  .row{display:flex;flex-wrap:wrap;gap:12px}
  .btn{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-weight:700}
  .btn-primary{background:var(--pri);color:var(--pri-fg)}
  .btn-ghost{background:transparent;border:1px solid var(--bd);color:var(--fg)}
  .hint{font-size:13px;color:var(--muted);margin-top:10px}
  .hidden{display:none}
  .center{display:flex;align-items:center;justify-content:center;height:40vh}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>เปิดด้วยแอป ReadAWrite</h1>
      <p>ถ้าเปิดจาก Facebook/LINE แล้วไม่เด้ง ให้กด <b>เปิดด้วยเบราว์เซอร์หลัก</b> ก่อน แล้วค่อยกด <b>เปิดในแอป</b></p>
      <div class="row" style="margin-top:14px">
        <button id="openApp" class="btn btn-primary">เปิดในแอป</button>
        <button id="openBrowser" class="btn btn-ghost">เปิดด้วยเบราว์เซอร์หลัก</button>
        <button id="copyLink" class="btn btn-ghost">คัดลอกลิงก์</button>
      </div>
      <div class="hint" id="msg"></div>
    </div>
    <div class="center hidden" id="spinner" aria-hidden="true">
      <div class="hint">กำลังพยายามเปิดแอป…</div>
    </div>
  </div>

<script>
/** ===========================
 *  CONFIG — ปรับได้เฉพาะบล็อกนี้
 *  =========================== */
const ANDROID_PKG = "com.meb.raw2";              // แพ็กเกจ Android ของ ReadAWrite
const SCHEMES     = ["readawrite", "raw", "raw2"]; // ลองทีละ scheme (กันกรณีเวอร์ชันแอปต่างกัน)
const WEB_HOST    = "https://www.readawrite.com"; // เว็บ fallback
// หากทราบลิงก์ App Store ให้ใส่ที่นี่ (ไม่ทราบปล่อยว่างได้)
const IOS_STORE   = ""; // ตัวอย่าง: "https://apps.apple.com/th/app/xxxxxxxx/id1234567890"

/** เอา path จาก ?u=... มาต่อท้ายลิงก์ปลายทาง ให้แชร์ลิงก์เฉพาะเรื่องได้ */
const urlParams = new URLSearchParams(location.search);
const encodedU = urlParams.get("u") || ""; // เช่น u=/a/512604c87af04b0b7d3d02f31a2289be
const TARGET_PATH = encodedU.startsWith("/") ? encodedU : "";
const WEB_URL   = WEB_HOST + (TARGET_PATH || "");
// deep link ครบชุด: scheme:// + path
const DEEPLINKS = SCHEMES.map(s => `${s}://${TARGET_PATH.replace(/^\//,"")}`);

/** ตรวจ UA */
const ua = navigator.userAgent || "";
const isAndroid = /Android/i.test(ua);
const isIOS     = /iPhone|iPad|iPod/i.test(ua);
const isFB      = /\bFBAN|FBAV|FB_IAB|FB4A|FB_IAB\/FBAV/i.test(ua);
const isIG      = /\bInstagram/i.test(ua);
const isLINE    = /\bLine\/|LIFF|Line/i.test(ua);
const inApp     = isFB || isIG || isLINE;

/** ความช่วยเหลือ */
const $ = sel => document.querySelector(sel);
const msg = (t)=> { const el=$("#msg"); if(el){ el.textContent=t; }};

function openInExternalBrowser() {
  try {
    // iOS: เปิดใน Safari
    if (isIOS && window.navigator && "standalone" in window.navigator) {
      alert("บน iPhone ให้แตะ ••• หรือ แชร์ แล้วเลือก 'เปิดใน Safari'");
    }
  } catch(e){}
  // พยายามบังคับออกเบราว์เซอร์หลักให้มากที่สุด
  window.location.href = WEB_URL;
}

function attemptOpenApp() {
  const spinner = $("#spinner");
  spinner.classList.remove("hidden");
  msg("กำลังพยายามเปิดแอป…");

  let done = false;
  const finish = ()=>{ if(!done){ done = true; spinner.classList.add("hidden"); } };

  // ถ้าเปิดแอปสำเร็จ หน้าจะถูกปิด/ซ่อน → ยกเลิก fallback
  const visHandler = ()=>{ if(document.hidden){ done = true; } };
  document.addEventListener("visibilitychange", visHandler, {once:false});

  // ตั้ง fallback เผื่อไม่เด้ง
  const t = setTimeout(()=> {
    if (done) return finish();
    // iOS ไม่มี intent: ไป App Store (ถ้าระบุ) ไม่ก็เว็บ
    if (isIOS) {
      window.location.href = IOS_STORE || WEB_URL;
    } else {
      // Android: เผื่อ iframe/scheme ไม่เด้ง ให้ fallback เว็บ
      window.location.href = WEB_URL;
    }
    finish();
  }, isIOS ? 1200 : 900);

  // วิธีเปิดแอปตามแพลตฟอร์ม
  try {
    if (isAndroid) {
      // 1) ลอง intent URI เจาะจงแพ็กเกจ (เสถียรสุดบน Chrome)
      const intentUri = `intent://${TARGET_PATH.replace(/^\//,"")}#Intent;scheme=${SCHEMES[0]};package=${ANDROID_PKG};S.browser_fallback_url=${encodeURIComponent(WEB_URL)};end`;
      window.location.href = intentUri;
      // 2) เผื่อเบราว์เซอร์ไม่รองรับ intent → ยิงผ่าน iframe ด้วย scheme สำรอง
      setTimeout(()=> {
        if (done) return;
        const iframe = document.createElement("iframe");
        iframe.style.display="none";
        iframe.src = DEEPLINKS[1] || DEEPLINKS[0];
        document.body.appendChild(iframe);
        setTimeout(()=> iframe.remove(), 1200);
      }, 200);
    } else if (isIOS) {
      // iOS ต้องอาศัย user gesture → ใช้ location ไปที่ scheme ตรง ๆ
      window.location.href = DEEPLINKS[0];
      // เผื่อ scheme ตัวแรกใช้ไม่ได้ ลองตัวถัดไปอย่างสุภาพ
      setTimeout(()=> { if(!done) window.location.href = (DEEPLINKS[1]||DEEPLINKS[0]); }, 350);
    } else {
      // อื่น ๆ (เดสก์ท็อป): เปิดเว็บ
      window.location.href = WEB_URL;
    }
  } catch (e) {
    // ถ้ามีข้อยกเว้น ไปเว็บเลย
    clearTimeout(t);
    window.location.href = WEB_URL;
    finish();
  }
}

function copyCurrentLink() {
  const link = location.origin + location.pathname + (TARGET_PATH?`?u=${encodeURIComponent(TARGET_PATH)}`:"");
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(link).then(()=> msg("คัดลอกลิงก์แล้ว")).catch(()=> msg("คัดลอกไม่สำเร็จ"));
  } else {
    // fallback เก่า ๆ
    const ta = document.createElement("textarea");
    ta.value = link; document.body.appendChild(ta); ta.select();
    try { document.execCommand("copy"); msg("คัดลอกลิงก์แล้ว"); } catch(e){ msg("คัดลอกไม่สำเร็จ"); }
    ta.remove();
  }
}

/** ติดปุ่ม */
$("#openApp").addEventListener("click", attemptOpenApp);
$("#copyLink").addEventListener("click", copyCurrentLink);
$("#openBrowser").addEventListener("click", openInExternalBrowser);

/** ถ้าไม่ได้เปิดจาก in‑app browser ให้ auto เปิดทันที (ประสบการณ์ดีที่สุด) */
if (!inApp) {
  // หน่วงเล็กน้อยให้หน้า render ปุ่มก่อน
  setTimeout(attemptOpenApp, 200);
} else {
  msg("ตรวจพบว่าเปิดจากแอปภายใน (เช่น Facebook/LINE) — แนะนำให้กด 'เปิดด้วยเบราว์เซอร์หลัก' ก่อนแล้วค่อยกด 'เปิดในแอป'");
}
</script>
</body>
</html>
